WebSocket –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞: –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π README

–≠—Ç–æ—Ç —Ñ–∞–π–ª –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å WebSocket-—Å–ª–æ–π –±—ç–∫–µ–Ω–¥–∞ (Spring Boot 3.5) –∏–∑–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞. –û–Ω –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, –∞ –Ω–µ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.

‚∏ª

1. –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
    1.	–ó–∞–ø—É—Å—Ç–∏ Postgres (–ø–æ—Ä—Ç, –±–∞–∑–∞, –ø–∞—Ä–æ–ª—å ‚Äî —Å–º. application-dev.yml).
    2.	–í—ã–ø–æ–ª–Ω–∏ ./gradlew bootRun -Pprofiles=dev.
    3.	–ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ —Å–æ–∫–µ—Ç—É:

websocat "ws://localhost:8080/ws?token=<JWT>"

JWT –º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ /auth/login.

–ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, —Å–µ—Ä–≤–µ—Ä —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–∏—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ {"type":"SYSTEM","payload":"CONNECTED"}.

‚∏ª

2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–¥–∞

ws/
‚îú‚îÄ config/           ‚Üí  Handshake + CORS + STOMP-free routing
‚îú‚îÄ gateway/          ‚Üí  WebSocketGateway (—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞)
‚îú‚îÄ session/          ‚Üí  SessionRegistry (–≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏)
‚îú‚îÄ handler/
‚îÇ   ‚îú‚îÄ BaseHandler   ‚Üí  üí° –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å-—à–∞–±–ª–æ–Ω
‚îÇ   ‚îî‚îÄ *Handler      ‚Üí  –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –∫–∞–∂–¥—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è
‚îú‚îÄ model/
‚îÇ   ‚îú‚îÄ WsRequest     ‚Üí  –æ–±—â–∏–π DTO –≤—Ö–æ–¥—è—â–∏—Ö –ø–∞–∫–µ—Ç–æ–≤
‚îÇ   ‚îî‚îÄ WsResponse    ‚Üí  –æ–±—â–∏–π DTO –∏—Å—Ö–æ–¥—è—â–∏—Ö –ø–∞–∫–µ—Ç–æ–≤
‚îî‚îÄ service/
‚îî‚îÄ BroadcastingService ‚Üí  –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–∞—Å–∞–¥ –¥–ª—è push-—Å–æ–±—ã—Ç–∏–π

–ö–ª—é—á–µ–≤—ã–µ –∏–¥–µ–∏
‚Ä¢	OOP ‚Äî –ª—é–±–æ–π –Ω–æ–≤—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è = –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π MessageHandler<T>.
‚Ä¢	–ê–≤—Ç–æ–¥–µ—Ç–µ–∫—Ü–∏—è ‚Äî WebSocketGateway –Ω–∞ —Å—Ç–∞—Ä—Ç–µ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç, —Å—Ç—Ä–æ–∏—Ç –º–∞–ø—É type ‚Üí handler.
‚Ä¢	Single Responsibility ‚Äî –≤—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ª–∏—à—å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –≤—Ö–æ–¥ ‚Üî –≤—ã—Ö–æ–¥.

‚∏ª

3. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å–µ—Å—Å–∏–∏
    1.	Handshake ‚Äî Custom HandshakeInterceptor –∏–∑–≤–ª–µ–∫–∞–µ—Ç JWT, –∫–ª–∞–¥—ë—Ç UserPrincipal –≤ WebSocketSession.
    2.	Register ‚Äî SessionRegistry –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏—é –≤ –∫–∞—Ä—Ç—É userId ‚Üí Set<WebSocketSession>.
    3.	In ‚Äî –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ñ—Ä–µ–π–º–∞ Gateway:
    1.	–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –≤ WsRequest;
    2.	–Ω–∞—Ö–æ–¥–∏—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ type;
    3.	–ø–µ—Ä–µ–¥–∞—ë—Ç payload –≤ –±–∏–∑–Ω–µ—Å-—Å–ª–æ–π.
    4.	Out ‚Äî –û—Ç–≤–µ—Ç —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ JSON –∏ –ø–∏—à–µ—Ç—Å—è –≤ –∏—Å—Ö–æ–¥—è—â—É—é –æ—á–µ—Ä–µ–¥—å —Å–µ—Å—Å–∏–∏.
    5.	Cleanup ‚Äî –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è Registry —É–±–∏—Ä–∞–µ—Ç —Å–µ—Å—Å–∏—é.

‚∏ª

4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    1.	DTO  —Å–æ–∑–¥–∞–π –≤ ws.model.*:

data class Ping(val timestamp: Long)


	2.	Handler:

@Component
class PingHandler(private val timeSvc: TimeService) : MessageHandler<Ping> {
override val type = "PING"
override suspend fun handle(msg: Ping, ctx: WsContext): WsResponse {
return ok("PONG @ ${timeSvc.now()}")
}
}


	3.	–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:

{"type":"PING","payload":{"timestamp":172432423}}

–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç {"type":"PING","payload":"PONG @ ‚Ä¶"}.

–°–æ–≤–µ—Ç—ã
‚Ä¢	–ò–º—è —Ç–∏–ø–∞ —Ä–µ–≥–∏—Å—Ç—Ä—É –Ω–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ ‚Äî –ø—Ä–∏–≤–æ–¥–∏–º –∫ UPPER_CASE.
‚Ä¢	–ù–µ –∑–∞–ø—É—Å–∫–∞–π –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ; –∏—Å–ø–æ–ª—å–∑—É–π withContext(Dispatchers.IO).

‚∏ª

5. –°–µ—Ä–≤–µ—Ä–Ω—ã–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

@Service
class CommentService(
private val repo: CommentRepo,
private val broadcaster: BroadcastingService
) {
fun addComment(dto: NewCommentDto) {
val comment = repo.save(dto.toEntity())
broadcaster.broadcastToUser(dto.postAuthorId, NewCommentEvent(comment))
}
}

BroadcastingService —É–º–µ–µ—Ç:
‚Ä¢	broadcastToUser(userId, event) ‚Äî –≤—Å–µ–º —Å–µ—Å—Å–∏—è–º —é–∑–µ—Ä–∞;
‚Ä¢	broadcast(event) ‚Äî –≤—Å–µ–º –æ–Ω–ª–∞–π–Ω-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º;
‚Ä¢	dispatch(sessionId, event) ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Å—Å–∏–∏.

‚∏ª

6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

–í application.yml (-dev / -prod):

ws:
path: /ws            # URL —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞
allowed-origins: "*" # CORS –¥–ª—è dev, —É–∂–µ—Å—Ç–æ—á—å –≤ prod
buffer-size: 8192    # bytes
idle-timeout: 60s

–ò–∑–º–µ–Ω–∏–ª ‚Äî WebSocketConfig –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç –Ω–∞ —Å—Ç–∞—Ä—Ç–µ.

‚∏ª

7. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
   ‚Ä¢	Handshake ‚Äî —Ç–æ–ª—å–∫–æ —Å –≤–∞–ª–∏–¥–Ω—ã–º JWT.
   ‚Ä¢	–ü—Ä–∏ —Ä–µ–≤–æ–∫–µ —Ç–æ–∫–µ–Ω–∞ –Ω—É–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏: SessionRegistry.closeAll(userId).
   ‚Ä¢	–í—Å–µ –æ—à–∏–±–∫–∏ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ WsError –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É: {type:"ERROR", payload:{code, message}}.

‚∏ª

8. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
   ‚Ä¢	Unit ‚Äî —Ç–µ—Å—Ç–∏—Ä—É–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ, –ø–æ–¥—Å—Ç–∞–≤–ª—è—è —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π WsContext.
   ‚Ä¢	Integration ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º WebSocketClient –∏–∑ org.springframework.web.socket.client.standard + —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Postgres.
   ‚Ä¢	E2E ‚Äî websocat, wscat –∏–ª–∏ Cypress –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞.

‚∏ª

9. –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ
   ‚Ä¢	CloseStatus(4401) ‚Äî –Ω–µ–≤–µ—Ä–Ω—ã–π JWT ‚Üí –æ–±–Ω–æ–≤–∏ —Ç–æ–∫–µ–Ω.
   ‚Ä¢	CloseStatus(1009) ‚Äî –ø—Ä–µ–≤—ã—à–µ–Ω buffer-size ‚Üí —É–º–µ–Ω—å—à–∏ payload –∏–ª–∏ —É–≤–µ–ª–∏—á—å –ø–∞—Ä–∞–º–µ—Ç—Ä.
   ‚Ä¢	Handler –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí —É–±–µ–¥–∏—Å—å, —á—Ç–æ –∫–ª–∞—Å—Å –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω @Component –∏ type —Å–æ–≤–ø–∞–¥–∞–µ—Ç.

‚∏ª

10. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞ –±—É–¥—É—â–µ–µ
    ‚Ä¢	–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ STOMP (–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è frame-routing).
    ‚Ä¢	–ö–∞–Ω–∞–ª –¥–ª—è staff-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ‚Üí –≤—ã–¥–µ–ª–∏—Ç—å Topic-based broadcasting.
    ‚Ä¢	–í—ã–¥–µ–ª–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π metrics-interceptor ‚Üí –º–µ—Ç—Ä–∏–∫–∏ –≤ Prometheus –ø–æ latency.

‚∏ª

11. –ü–æ–ª–µ–∑–Ω—ã–µ —Å–Ω–∏–ø–ø–µ—Ç—ã

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∂–∏–≤–æ—Å—Ç–∏ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π (dev-endpoint)
curl -H "Authorization: Bearer <admin_token>" http://localhost:8080/actuator/ws/sessions

# –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å—à–µ–π —Å–µ—Å—Å–∏–∏
curl -X DELETE "http://localhost:8080/actuator/ws/sessions/{sessionId}" \
-H "Authorization: Bearer <admin_token>"


‚∏ª

–ì–æ—Ç–æ–≤–æ! –ï—Å–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã ‚Äî –ø–∏—à–∏!